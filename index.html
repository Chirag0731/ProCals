<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <title>ProCals ‚Äî AI Calorie Tracker</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üî•</text></svg>" />
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: #f5f2ee; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;

    const GOOGLE_CLIENT_ID = "577211690181-gq3r3bvabk6akognjo6vd7girco2dg10.apps.googleusercontent.com";
    const DAILY_GOAL = 2000;
    const FREE_LIMIT = 3;

    const STYLES = `
      @import url('https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700&family=Fraunces:ital,wght@0,700;1,400&family=DM+Mono:wght@400;500&display=swap');

      * { box-sizing: border-box; margin: 0; padding: 0; }
      :root {
        --bg: #f5f2ee; --white: #ffffff; --surface: #faf8f6; --border: #e8e3dc;
        --accent: #ff5c35; --accent-soft: #fff0ec; --accent2: #6c63ff;
        --green: #22c55e; --text: #1a1714; --text-mid: #6b6560; --text-muted: #b0aba5;
        --red: #ef4444; --shadow: 0 2px 12px rgba(0,0,0,0.06); --shadow-lg: 0 8px 32px rgba(0,0,0,0.10);
      }
      body { background: var(--bg); color: var(--text); font-family: 'Sora', sans-serif; min-height: 100vh; }
      .app { max-width: 430px; margin: 0 auto; padding-bottom: 80px; min-height: 100vh; }

      /* HEADER */
      .header { background: var(--white); padding: 20px 20px 0; position: sticky; top: 0; z-index: 20; box-shadow: 0 1px 0 var(--border); }
      .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 18px; }
      .logo { display: flex; align-items: center; gap: 8px; }
      .logo-icon { width: 32px; height: 32px; background: var(--accent); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 16px; }
      .logo-text { font-family: 'Fraunces', serif; font-size: 22px; font-weight: 700; letter-spacing: -0.5px; color: var(--text); }
      .logo-text em { font-style: italic; color: var(--accent); }
      .reset-btn { background: none; border: 1.5px solid var(--border); color: var(--text-mid); font-family: 'Sora', sans-serif; font-size: 11px; font-weight: 500; padding: 7px 14px; border-radius: 20px; cursor: pointer; transition: all 0.2s; }
      .reset-btn:hover { border-color: var(--red); color: var(--red); background: #fff5f5; }

      /* RING */
      .cal-ring-section { display: flex; align-items: center; gap: 20px; padding: 0 20px 20px; background: var(--white); }
      .ring-wrap { position: relative; width: 88px; height: 88px; flex-shrink: 0; }
      .ring-wrap svg { transform: rotate(-90deg); }
      .ring-center { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; line-height: 1; }
      .ring-num { font-family: 'Fraunces', serif; font-size: 19px; font-weight: 700; color: var(--text); }
      .ring-sub { font-size: 8px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2px; }
      .cal-info { flex: 1; }
      .cal-info-label { font-size: 11px; font-weight: 500; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 2px; }
      .cal-info-num { font-family: 'Fraunces', serif; font-size: 36px; font-weight: 700; line-height: 1; color: var(--text); margin-bottom: 4px; }
      .cal-info-num span { font-family: 'Sora', sans-serif; font-size: 14px; font-weight: 400; color: var(--text-muted); }
      .cal-remaining { display: inline-flex; align-items: center; gap: 5px; background: var(--accent-soft); color: var(--accent); font-size: 11px; font-weight: 600; padding: 4px 10px; border-radius: 20px; }
      .cal-remaining.over { background: #fff0f0; color: var(--red); }

      /* MACROS */
      .macro-pills { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; padding: 14px 20px; background: var(--white); border-top: 1px solid var(--border); }
      .macro-pill { background: var(--bg); border-radius: 14px; padding: 12px 10px; text-align: center; }
      .macro-pill-val { font-family: 'Fraunces', serif; font-size: 20px; font-weight: 700; line-height: 1; color: var(--text); }
      .macro-pill-val span { font-family: 'Sora'; font-size: 11px; font-weight: 400; color: var(--text-muted); }
      .macro-pill-label { font-size: 10px; font-weight: 500; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-top: 3px; }
      .macro-pill.protein .macro-pill-val { color: #f97316; }
      .macro-pill.carbs .macro-pill-val { color: var(--accent2); }
      .macro-pill.fat .macro-pill-val { color: var(--green); }

      /* GOAL BAR */
      .goal-bar-wrap { padding: 14px 20px; background: var(--white); border-top: 1px solid var(--border); display: flex; align-items: center; gap: 10px; }
      .goal-label-text { font-size: 11px; font-weight: 500; color: var(--text-muted); white-space: nowrap; }
      .goal-input { background: var(--bg); border: 1.5px solid var(--border); color: var(--text); font-family: 'Sora', sans-serif; font-size: 13px; font-weight: 600; padding: 7px 10px; border-radius: 10px; width: 82px; text-align: center; transition: border-color 0.2s; outline: none; }
      .goal-input:focus { border-color: var(--accent); }
      .goal-kcal { font-size: 11px; color: var(--text-muted); }

      /* CONTENT */
      .content { padding: 16px 20px 0; }

      /* UPLOAD CARD */
      .upload-card { background: var(--white); border-radius: 20px; overflow: hidden; box-shadow: var(--shadow); margin-bottom: 14px; }
      .capture-zone { position: relative; height: 190px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; background: var(--surface); border-bottom: 1.5px dashed var(--border); }
      .capture-zone.has-image { border-bottom-style: solid; border-color: var(--accent); }
      .capture-zone:hover:not(.has-image) { background: var(--accent-soft); border-color: var(--accent); }
      .capture-zone img { width: 100%; height: 100%; object-fit: cover; position: absolute; inset: 0; }
      .capture-overlay { position: absolute; inset: 0; background: rgba(255,92,53,0.7); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; opacity: 0; transition: opacity 0.2s; backdrop-filter: blur(2px); }
      .capture-zone.has-image:hover .capture-overlay { opacity: 1; }
      .capture-overlay span { color: white; font-size: 12px; font-weight: 600; }
      .upload-empty { display: flex; flex-direction: column; align-items: center; gap: 8px; }
      .upload-icon-wrap { width: 56px; height: 56px; background: var(--accent-soft); border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 26px; }
      .upload-text { font-size: 13px; font-weight: 600; color: var(--text); }
      .upload-sub { font-size: 11px; color: var(--text-muted); }
      .card-actions { display: grid; grid-template-columns: 1fr 1fr; }
      .action-btn { padding: 13px 10px; background: none; border: none; font-family: 'Sora', sans-serif; font-size: 12px; font-weight: 600; color: var(--text-mid); cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; transition: all 0.15s; border-top: 1.5px solid var(--border); }
      .action-btn:first-child { border-right: 1px solid var(--border); }
      .action-btn:hover { background: var(--bg); color: var(--text); }
      .upload-counter { display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; background: var(--surface); border-top: 1px solid var(--border); }
      .counter-dots { display: flex; gap: 6px; }
      .counter-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--border); transition: background 0.3s; }
      .counter-dot.used { background: var(--accent); }
      .counter-label { font-size: 11px; font-weight: 500; color: var(--text-muted); }
      .counter-label strong { color: var(--text-mid); }

      /* ANALYZE BTN */
      .analyze-btn { width: 100%; padding: 16px; background: var(--accent); color: white; border: none; border-radius: 16px; font-family: 'Sora', sans-serif; font-size: 14px; font-weight: 700; cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden; margin-bottom: 14px; box-shadow: 0 4px 16px rgba(255,92,53,0.3); }
      .analyze-btn:hover:not(:disabled) { background: #e84d29; transform: translateY(-1px); }
      .analyze-btn:disabled { background: var(--border); color: var(--text-muted); cursor: not-allowed; box-shadow: none; transform: none; }
      .analyze-btn.loading { background: #ff7a5c; cursor: wait; }
      .analyze-btn.loading::before { content: ''; position: absolute; inset: 0; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent); animation: shimmer 1.2s ease-in-out infinite; }
      @keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }

      /* RESULT CARD */
      .result-card { background: var(--white); border-radius: 20px; overflow: hidden; box-shadow: var(--shadow-lg); margin-bottom: 14px; border: 2px solid var(--accent); animation: pop-in 0.3s cubic-bezier(0.34,1.56,0.64,1); }
      @keyframes pop-in { from { opacity: 0; transform: scale(0.95) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
      .result-hero { background: linear-gradient(135deg, var(--accent) 0%, #ff8660 100%); padding: 18px 20px; display: flex; justify-content: space-between; align-items: flex-start; }
      .result-name { font-family: 'Fraunces', serif; font-size: 20px; font-weight: 700; color: white; flex: 1; padding-right: 16px; line-height: 1.2; }
      .result-cals-block { text-align: right; flex-shrink: 0; }
      .result-cals { font-family: 'Fraunces', serif; font-size: 38px; font-weight: 700; color: white; line-height: 1; }
      .result-cals-label { font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.75); text-transform: uppercase; letter-spacing: 1px; }
      .result-macros { display: grid; grid-template-columns: 1fr 1fr 1fr; padding: 14px 20px; gap: 8px; }
      .result-macro { text-align: center; padding: 10px; background: var(--surface); border-radius: 12px; }
      .result-macro-val { font-family: 'Fraunces', serif; font-size: 18px; font-weight: 700; color: var(--text); }
      .result-macro-val span { font-family: 'Sora'; font-size: 11px; font-weight: 400; color: var(--text-muted); }
      .result-macro-label { font-size: 10px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.8px; margin-top: 2px; }
      .result-notes { font-size: 12px; color: var(--text-mid); line-height: 1.6; padding: 0 20px 14px; }
      .add-log-btn { width: calc(100% - 40px); margin: 0 20px 18px; padding: 13px; background: var(--accent-soft); border: 2px solid var(--accent); color: var(--accent); font-family: 'Sora', sans-serif; font-size: 13px; font-weight: 700; border-radius: 12px; cursor: pointer; transition: all 0.2s; }
      .add-log-btn:hover { background: var(--accent); color: white; }

      /* ERROR */
      .error-msg { background: #fff5f5; border: 1.5px solid var(--red); color: var(--red); padding: 12px 16px; border-radius: 12px; font-size: 12px; margin-bottom: 14px; line-height: 1.5; }

      /* LOG */
      .log-section { padding: 0 20px; margin-top: 4px; }
      .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
      .section-title { font-size: 13px; font-weight: 700; color: var(--text); }
      .section-count { background: var(--accent-soft); color: var(--accent); font-size: 11px; font-weight: 700; padding: 3px 10px; border-radius: 20px; }
      .log-empty { text-align: center; padding: 32px 20px; color: var(--text-muted); font-size: 13px; background: var(--white); border-radius: 16px; border: 1.5px dashed var(--border); line-height: 1.6; }
      .log-item { display: flex; gap: 12px; align-items: center; padding: 12px 14px; background: var(--white); border-radius: 14px; margin-bottom: 8px; box-shadow: var(--shadow); animation: slide-in 0.25s ease; }
      @keyframes slide-in { from { opacity: 0; transform: translateY(-6px); } to { opacity: 1; transform: translateY(0); } }
      .log-thumb { width: 48px; height: 48px; object-fit: cover; border-radius: 10px; flex-shrink: 0; }
      .log-info { flex: 1; min-width: 0; }
      .log-name { font-size: 13px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 4px; }
      .log-macros { display: flex; gap: 8px; font-size: 11px; color: var(--text-muted); }
      .log-macros .kcal { font-weight: 700; color: var(--accent); }
      .log-meta { display: flex; flex-direction: column; align-items: flex-end; gap: 8px; flex-shrink: 0; }
      .log-time { font-size: 10px; font-weight: 500; color: var(--text-muted); }
      .log-delete { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 16px; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.15s; }
      .log-delete:hover { background: #fff0f0; color: var(--red); }
      input[type="file"] { display: none; }

      /* LIMIT BANNER */
      .limit-banner { background: linear-gradient(135deg, #1a1714 0%, #2d2520 100%); border-radius: 16px; padding: 18px 20px; margin-bottom: 14px; display: flex; align-items: center; gap: 14px; box-shadow: var(--shadow-lg); }
      .limit-icon { font-size: 28px; flex-shrink: 0; }
      .limit-text { flex: 1; }
      .limit-title { font-size: 14px; font-weight: 700; color: white; margin-bottom: 3px; }
      .limit-sub { font-size: 11px; color: rgba(255,255,255,0.55); line-height: 1.4; }
      .upgrade-btn-inline { background: var(--accent); color: white; border: none; border-radius: 10px; font-family: 'Sora', sans-serif; font-size: 11px; font-weight: 700; padding: 8px 14px; cursor: pointer; white-space: nowrap; transition: all 0.2s; flex-shrink: 0; }
      .upgrade-btn-inline:hover { background: #e84d29; }

      /* MODAL */
      .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 100; display: flex; align-items: flex-end; justify-content: center; animation: fade-in 0.2s ease; }
      @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
      .modal { background: var(--white); border-radius: 28px 28px 0 0; padding: 32px 24px 40px; width: 100%; max-width: 430px; animation: slide-up 0.35s cubic-bezier(0.34,1.56,0.64,1); }
      @keyframes slide-up { from { transform: translateY(100%); } to { transform: translateY(0); } }
      .modal-handle { width: 36px; height: 4px; background: var(--border); border-radius: 4px; margin: 0 auto 24px; }
      .modal-header { text-align: center; margin-bottom: 24px; }
      .modal-badge { display: inline-flex; align-items: center; gap: 6px; background: linear-gradient(135deg, #ff5c35, #ff8660); color: white; font-size: 11px; font-weight: 700; padding: 5px 14px; border-radius: 20px; margin-bottom: 12px; text-transform: uppercase; }
      .modal-title { font-family: 'Fraunces', serif; font-size: 28px; font-weight: 700; color: var(--text); line-height: 1.2; margin-bottom: 8px; }
      .modal-sub { font-size: 14px; color: var(--text-mid); line-height: 1.5; }
      .modal-features { background: var(--bg); border-radius: 16px; padding: 16px; margin-bottom: 20px; }
      .modal-feature { display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid var(--border); font-size: 13px; font-weight: 500; color: var(--text); }
      .modal-feature:last-child { border-bottom: none; }
      .feature-check { width: 22px; height: 22px; background: var(--accent-soft); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; flex-shrink: 0; }
      .modal-price { text-align: center; margin-bottom: 16px; }
      .price-amount { font-family: 'Fraunces', serif; font-size: 42px; font-weight: 700; color: var(--text); line-height: 1; }
      .price-period { font-size: 14px; color: var(--text-muted); margin-top: 2px; }
      .modal-cta { width: 100%; padding: 18px; background: linear-gradient(135deg, var(--accent) 0%, #ff8660 100%); color: white; border: none; border-radius: 16px; font-family: 'Sora', sans-serif; font-size: 15px; font-weight: 700; cursor: pointer; transition: all 0.2s; box-shadow: 0 6px 20px rgba(255,92,53,0.35); margin-bottom: 12px; }
      .modal-cta:hover { transform: translateY(-1px); }
      .modal-dismiss { width: 100%; padding: 14px; background: none; border: none; font-family: 'Sora', sans-serif; font-size: 13px; color: var(--text-muted); cursor: pointer; }
      .modal-dismiss:hover { color: var(--text); }

      /* PREMIUM BADGE */
      .premium-badge { display: inline-flex; align-items: center; gap: 4px; background: linear-gradient(135deg, #ff5c35, #ff8660); color: white; font-size: 10px; font-weight: 700; padding: 3px 8px; border-radius: 20px; }

      /* USER PILL */
      .user-pill { display: flex; align-items: center; gap: 8px; background: var(--surface); border: 1.5px solid var(--border); border-radius: 20px; padding: 4px 12px 4px 6px; cursor: pointer; transition: all 0.2s; }
      .user-pill:hover { border-color: var(--red); }
      .user-avatar { width: 26px; height: 26px; border-radius: 50%; background: linear-gradient(135deg, var(--accent), #ff8660); display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; color: white; overflow: hidden; }
      .user-name { font-size: 12px; font-weight: 600; color: var(--text); }

      /* AUTH SCREEN */
      .auth-screen { min-height: 100vh; background: var(--bg); display: flex; flex-direction: column; max-width: 430px; margin: 0 auto; padding: 0 24px 40px; }
      .auth-top { display: flex; flex-direction: column; align-items: center; padding: 56px 0 36px; }
      .auth-logo-wrap { width: 64px; height: 64px; background: var(--accent); border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 30px; margin-bottom: 16px; box-shadow: 0 8px 24px rgba(255,92,53,0.35); }
      .auth-logo-text { font-family: 'Fraunces', serif; font-size: 32px; font-weight: 700; color: var(--text); letter-spacing: -1px; margin-bottom: 6px; }
      .auth-logo-text em { font-style: italic; color: var(--accent); }
      .auth-tagline { font-size: 13px; color: var(--text-muted); text-align: center; line-height: 1.5; }
      .auth-card { background: var(--white); border-radius: 24px; padding: 28px 24px; box-shadow: var(--shadow-lg); }
      .auth-tabs { display: grid; grid-template-columns: 1fr 1fr; background: var(--bg); border-radius: 12px; padding: 4px; margin-bottom: 24px; }
      .auth-tab { padding: 10px; border: none; background: none; border-radius: 9px; font-family: 'Sora', sans-serif; font-size: 13px; font-weight: 600; color: var(--text-muted); cursor: pointer; transition: all 0.2s; }
      .auth-tab.active { background: var(--white); color: var(--text); box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
      .auth-google-btn { width: 100%; padding: 14px; background: var(--white); border: 1.5px solid var(--border); border-radius: 14px; font-family: 'Sora', sans-serif; font-size: 14px; font-weight: 600; color: var(--text); cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.2s; margin-bottom: 20px; box-shadow: var(--shadow); }
      .auth-google-btn:hover:not(:disabled) { border-color: #4285F4; background: #f8f9ff; transform: translateY(-1px); }
      .auth-google-btn:disabled { opacity: 0.5; cursor: wait; }
      .auth-divider { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; }
      .auth-divider-line { flex: 1; height: 1px; background: var(--border); }
      .auth-divider-text { font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
      .auth-field { margin-bottom: 14px; }
      .auth-label { display: block; font-size: 11px; font-weight: 700; color: var(--text-mid); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; }
      .auth-input { width: 100%; padding: 13px 16px; background: var(--surface); border: 1.5px solid var(--border); border-radius: 12px; font-family: 'Sora', sans-serif; font-size: 14px; color: var(--text); transition: border-color 0.2s, box-shadow 0.2s; outline: none; }
      .auth-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(255,92,53,0.1); }
      .auth-input::placeholder { color: var(--text-muted); }
      .auth-input.error-field { border-color: var(--red); }
      .auth-error { background: #fff5f5; border: 1.5px solid var(--red); color: var(--red); padding: 10px 14px; border-radius: 10px; font-size: 12px; margin-bottom: 14px; line-height: 1.5; }
      .auth-submit-btn { width: 100%; padding: 16px; background: var(--accent); color: white; border: none; border-radius: 14px; font-family: 'Sora', sans-serif; font-size: 14px; font-weight: 700; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 16px rgba(255,92,53,0.3); margin-top: 4px; position: relative; overflow: hidden; }
      .auth-submit-btn:hover:not(:disabled) { background: #e84d29; transform: translateY(-1px); }
      .auth-submit-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
      .auth-submit-btn.loading::before { content: ''; position: absolute; inset: 0; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent); animation: shimmer 1.2s ease-in-out infinite; }
      .auth-footer-text { text-align: center; font-size: 11px; color: var(--text-muted); margin-top: 16px; line-height: 1.6; }
      .auth-footer-text a { color: var(--accent); font-weight: 600; cursor: pointer; text-decoration: none; }
      .auth-footer-text a:hover { text-decoration: underline; }
      .auth-forgot { text-align: right; font-size: 11px; font-weight: 600; color: var(--accent); cursor: pointer; margin-top: -8px; margin-bottom: 14px; }
      .auth-forgot:hover { opacity: 0.75; }
    `;

    // ‚îÄ‚îÄ Decode Google JWT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function decodeGoogleJWT(token) {
      try {
        const base64 = token.split(".")[1].replace(/-/g, "+").replace(/_/g, "/");
        const json = decodeURIComponent(
          atob(base64).split("").map(c => "%" + c.charCodeAt(0).toString(16).padStart(2, "0")).join("")
        );
        return JSON.parse(json);
      } catch { return null; }
    }

    // ‚îÄ‚îÄ AUTH SCREEN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function AuthScreen({ onAuth }) {
      const [tab, setTab] = useState("signup");
      const [name, setName] = useState("");
      const [email, setEmail] = useState("");
      const [password, setPassword] = useState("");
      const [confirm, setConfirm] = useState("");
      const [authError, setAuthError] = useState("");
      const [submitting, setSubmitting] = useState(false);
      const [gsiReady, setGsiReady] = useState(false);

      useEffect(() => {
        const init = () => {
          try {
            window.google.accounts.id.initialize({
              client_id: GOOGLE_CLIENT_ID,
              callback: (response) => {
                const payload = decodeGoogleJWT(response.credential);
                if (payload) onAuth({ name: payload.name, email: payload.email, picture: payload.picture, provider: "google" });
              },
              auto_select: false,
              cancel_on_tap_outside: true,
            });
            setGsiReady(true);
          } catch (e) { console.error("GSI init:", e); }
        };

        if (window.google?.accounts?.id) {
          init();
        } else {
          const old = document.getElementById("gsi-script");
          if (old) old.remove();
          const s = document.createElement("script");
          s.id = "gsi-script";
          s.src = "https://accounts.google.com/gsi/client";
          s.async = true;
          s.onload = init;
          document.head.appendChild(s);
        }
      }, []);

      const handleGoogleClick = () => {
        if (!gsiReady) return;
        window.google.accounts.id.prompt((n) => {
          if (n.isNotDisplayed() || n.isSkippedMoment()) {
            setAuthError("Google sign-in was blocked. Make sure popups are allowed and you're on a registered domain.");
          }
        });
      };

      const validate = () => {
        if (!email.includes("@") || !email.includes(".")) return "Please enter a valid email address.";
        if (password.length < 6) return "Password must be at least 6 characters.";
        if (tab === "signup") {
          if (!name.trim()) return "Please enter your name.";
          if (password !== confirm) return "Passwords do not match.";
        }
        return null;
      };

      const handleSubmit = () => {
        const err = validate();
        if (err) { setAuthError(err); return; }
        setAuthError("");
        setSubmitting(true);
        setTimeout(() => {
          setSubmitting(false);
          onAuth({ name: name || email.split("@")[0], email, provider: "email" });
        }, 1000);
      };

      const switchTab = (t) => {
        setTab(t); setAuthError("");
        setName(""); setEmail(""); setPassword(""); setConfirm("");
      };

      return (
        <div className="auth-screen">
          <div className="auth-top">
            <div className="auth-logo-wrap">üî•</div>
            <div className="auth-logo-text">Pro<em>Cals</em></div>
            <div className="auth-tagline">AI-powered calorie tracking.<br />Snap, analyze, and stay on track.</div>
          </div>
          <div className="auth-card">
            <div className="auth-tabs">
              <button className={`auth-tab ${tab === "signup" ? "active" : ""}`} onClick={() => switchTab("signup")}>Sign Up</button>
              <button className={`auth-tab ${tab === "login" ? "active" : ""}`} onClick={() => switchTab("login")}>Log In</button>
            </div>

            <button className="auth-google-btn" onClick={handleGoogleClick} disabled={!gsiReady}>
              <svg viewBox="0 0 24 24" width="20" height="20">
                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z"/>
                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
              </svg>
              {gsiReady ? "Continue with Google" : "Loading Google‚Ä¶"}
            </button>

            <div className="auth-divider">
              <div className="auth-divider-line" />
              <div className="auth-divider-text">or with email</div>
              <div className="auth-divider-line" />
            </div>

            {authError && <div className="auth-error">‚ö†Ô∏è {authError}</div>}

            {tab === "signup" && (
              <div className="auth-field">
                <label className="auth-label">Full Name</label>
                <input className="auth-input" type="text" placeholder="Jane Smith" value={name} onChange={e => setName(e.target.value)} />
              </div>
            )}
            <div className="auth-field">
              <label className="auth-label">Email</label>
              <input className="auth-input" type="email" placeholder="you@example.com" value={email} onChange={e => setEmail(e.target.value)} />
            </div>
            <div className="auth-field">
              <label className="auth-label">Password</label>
              <input className="auth-input" type="password" placeholder={tab === "signup" ? "Min. 6 characters" : "Your password"} value={password} onChange={e => setPassword(e.target.value)} onKeyDown={e => e.key === "Enter" && handleSubmit()} />
            </div>
            {tab === "signup" && (
              <div className="auth-field">
                <label className="auth-label">Confirm Password</label>
                <input className={`auth-input ${authError.includes("match") ? "error-field" : ""}`} type="password" placeholder="Repeat password" value={confirm} onChange={e => setConfirm(e.target.value)} onKeyDown={e => e.key === "Enter" && handleSubmit()} />
              </div>
            )}
            {tab === "login" && (
              <div className="auth-forgot" onClick={() => alert("Connect Firebase/Supabase to enable password reset.")}>Forgot password?</div>
            )}

            <button className={`auth-submit-btn ${submitting ? "loading" : ""}`} onClick={handleSubmit} disabled={submitting}>
              {submitting ? (tab === "signup" ? "Creating account‚Ä¶" : "Signing in‚Ä¶") : (tab === "signup" ? "Create Account" : "Sign In")}
            </button>

            <div className="auth-footer-text">
              {tab === "signup"
                ? <><a onClick={() => switchTab("login")}>Already have an account? Log in</a><br /><br />By signing up you agree to our <a href="#">Terms</a> &amp; <a href="#">Privacy Policy</a>.</>
                : <><a onClick={() => switchTab("signup")}>Don't have an account? Sign up free</a></>
              }
            </div>
          </div>
        </div>
      );
    }

    // ‚îÄ‚îÄ MAIN APP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function ProCals() {
      const [user, setUser] = useState(null);
      const [image, setImage] = useState(null);
      const [imageBase64, setImageBase64] = useState(null);
      const [loading, setLoading] = useState(false);
      const [result, setResult] = useState(null);
      const [error, setError] = useState(null);
      const [log, setLog] = useState([]);
      const [goal, setGoal] = useState(DAILY_GOAL);
      const [goalInput, setGoalInput] = useState(String(DAILY_GOAL));
      const [isPremium, setIsPremium] = useState(false);
      const [showPaywall, setShowPaywall] = useState(false);
      const [uploadsToday, setUploadsToday] = useState(0);
      const fileInputRef = useRef(null);
      const cameraInputRef = useRef(null);

      const atLimit = !isPremium && uploadsToday >= FREE_LIMIT;

      if (!user) {
        return (
          <>
            <style>{STYLES}</style>
            <AuthScreen onAuth={(u) => setUser(u)} />
          </>
        );
      }

      const today = new Date().toLocaleDateString("en-US", { weekday: "long", month: "long", day: "numeric" });
      const totals = log.reduce((acc, item) => ({
        calories: acc.calories + item.calories, protein: acc.protein + item.protein,
        carbs: acc.carbs + item.carbs, fat: acc.fat + item.fat,
      }), { calories: 0, protein: 0, carbs: 0, fat: 0 });

      const progressPct = Math.min((totals.calories / goal) * 100, 100);
      const overGoal = totals.calories > goal;
      const R = 36, C = 2 * Math.PI * R;
      const dash = (progressPct / 100) * C;

      const handleFile = (file) => {
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          setImage(e.target.result);
          setImageBase64(e.target.result.split(",")[1]);
          setResult(null); setError(null);
        };
        reader.readAsDataURL(file);
      };

      const analyze = async () => {
        if (!imageBase64) return;
        setLoading(true); setError(null); setResult(null);
        try {
          const response = await fetch("https://api.anthropic.com/v1/messages", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              model: "claude-sonnet-4-20250514",
              max_tokens: 1000,
              messages: [{ role: "user", content: [
                { type: "image", source: { type: "base64", media_type: "image/jpeg", data: imageBase64 } },
                { type: "text", text: `Analyze this food image. Return ONLY valid JSON:\n{"name":"food name (max 40 chars)","calories":number,"protein":number,"carbs":number,"fat":number,"notes":"brief note"}` }
              ]}],
            }),
          });
          const data = await response.json();
          if (data.error) throw new Error(data.error.message);
          const text = data.content.map(b => b.text || "").join("").replace(/```json|```/g, "").trim();
          setResult({ ...JSON.parse(text), imageUrl: image });
        } catch (err) {
          setError(err.message || "Failed to analyze image.");
        } finally { setLoading(false); }
      };

      const addToLog = () => {
        if (!result) return;
        setLog(prev => [{ ...result, id: Date.now(), time: new Date().toLocaleTimeString("en-US", { hour: "2-digit", minute: "2-digit" }) }, ...prev]);
        setUploadsToday(n => n + 1);
        setResult(null); setImage(null); setImageBase64(null);
      };

      return (
        <>
          <style>{STYLES}</style>
          <div className="app">
            <div className="header">
              <div className="header-row">
                <div className="logo">
                  <div className="logo-icon">üî•</div>
                  <div className="logo-text">Pro<em>Cals</em></div>
                </div>
                <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                  {isPremium && <div className="premium-badge">‚≠ê Premium</div>}
                  <div className="user-pill" onClick={() => { if (window.confirm("Sign out?")) setUser(null); }}>
                    <div className="user-avatar">
                      {user.picture
                        ? <img src={user.picture} alt="" style={{ width: "100%", height: "100%", objectFit: "cover" }} />
                        : user.name.charAt(0).toUpperCase()}
                    </div>
                    <div className="user-name">{user.name.split(" ")[0]}</div>
                  </div>
                  <button className="reset-btn" onClick={() => { setLog([]); setUploadsToday(0); }}>Reset</button>
                </div>
              </div>

              <div className="cal-ring-section">
                <div className="ring-wrap">
                  <svg width="88" height="88" viewBox="0 0 88 88">
                    <circle cx="44" cy="44" r={R} fill="none" stroke="var(--border)" strokeWidth="8" />
                    <circle cx="44" cy="44" r={R} fill="none" stroke={overGoal ? "var(--red)" : "var(--accent)"} strokeWidth="8" strokeLinecap="round" strokeDasharray={`${dash} ${C}`} style={{ transition: "stroke-dasharray 0.6s" }} />
                  </svg>
                  <div className="ring-center">
                    <div className="ring-num">{Math.round(progressPct)}%</div>
                    <div className="ring-sub">of goal</div>
                  </div>
                </div>
                <div className="cal-info">
                  <div className="cal-info-label">Calories Today</div>
                  <div className="cal-info-num">{totals.calories}<span> kcal</span></div>
                  <div className={`cal-remaining ${overGoal ? "over" : ""}`}>
                    {overGoal ? `‚ö† ${totals.calories - goal} over` : `${goal - totals.calories} kcal left`}
                  </div>
                </div>
              </div>

              <div className="macro-pills">
                {[{l:"Protein",v:totals.protein,c:"protein"},{l:"Carbs",v:totals.carbs,c:"carbs"},{l:"Fat",v:totals.fat,c:"fat"}].map(({l,v,c}) => (
                  <div key={l} className={`macro-pill ${c}`}>
                    <div className="macro-pill-val">{v}<span>g</span></div>
                    <div className="macro-pill-label">{l}</div>
                  </div>
                ))}
              </div>

              <div className="goal-bar-wrap">
                <div className="goal-label-text">Daily goal</div>
                <input type="number" className="goal-input" value={goalInput}
                  onChange={e => { const r = e.target.value.replace(/^0+(?=\d)/,""); setGoalInput(r); const n=parseInt(r,10); if(!isNaN(n)&&n>=500&&n<=10000) setGoal(n); }}
                  onBlur={() => { const n=parseInt(goalInput,10); if(isNaN(n)||n<500){setGoalInput("500");setGoal(500);}else if(n>10000){setGoalInput("10000");setGoal(10000);}else setGoalInput(String(n)); }}
                  min={500} max={10000} />
                <div className="goal-kcal">kcal</div>
                <div style={{flex:1}} />
                <div style={{fontSize:11,color:"var(--text-muted)"}}>{today}</div>
              </div>
            </div>

            <div className="content">
              <div className="upload-card">
                <div className={`capture-zone ${image ? "has-image" : ""}`} onClick={() => !image && !atLimit && fileInputRef.current?.click()} style={atLimit ? {cursor:"default",opacity:0.6} : {}}>
                  {image ? (
                    <><img src={image} alt="Food" /><div className="capture-overlay"><span style={{fontSize:26}}>üì∑</span><span>Change Photo</span></div></>
                  ) : (
                    <div className="upload-empty">
                      <div className="upload-icon-wrap">{atLimit ? "üîí" : "üçΩÔ∏è"}</div>
                      <div className="upload-text">{atLimit ? "Daily limit reached" : "Upload a food photo"}</div>
                      <div className="upload-sub">{atLimit ? "Upgrade for unlimited scans" : "Tap to browse or use camera below"}</div>
                    </div>
                  )}
                </div>
                {!isPremium && (
                  <div className="upload-counter">
                    <div className="counter-dots">{[0,1,2].map(i => <div key={i} className={`counter-dot ${i < uploadsToday ? "used" : ""}`} />)}</div>
                    <div className="counter-label"><strong>{uploadsToday}/3</strong> free scans today</div>
                  </div>
                )}
                <div className="card-actions">
                  <button className="action-btn" onClick={() => !atLimit && cameraInputRef.current?.click()} style={atLimit ? {opacity:0.4,cursor:"not-allowed"} : {}}><span>üì∏</span> Camera</button>
                  <button className="action-btn" onClick={() => !atLimit && fileInputRef.current?.click()} style={atLimit ? {opacity:0.4,cursor:"not-allowed"} : {}}><span>üñºÔ∏è</span> Gallery</button>
                </div>
              </div>

              <input ref={fileInputRef} type="file" accept="image/*" onChange={e => handleFile(e.target.files[0])} />
              <input ref={cameraInputRef} type="file" accept="image/*" capture="environment" onChange={e => handleFile(e.target.files[0])} />

              {atLimit && (
                <div className="limit-banner">
                  <div className="limit-icon">üîí</div>
                  <div className="limit-text">
                    <div className="limit-title">You've used all 3 free scans</div>
                    <div className="limit-sub">Upgrade to Premium for unlimited daily scans</div>
                  </div>
                  <button className="upgrade-btn-inline" onClick={() => setShowPaywall(true)}>Upgrade</button>
                </div>
              )}

              <button className={`analyze-btn ${loading ? "loading" : ""}`} onClick={atLimit ? () => setShowPaywall(true) : analyze} disabled={(!image || loading) && !atLimit} style={atLimit ? {background:"#1a1714",boxShadow:"none"} : {}}>
                {atLimit ? "üîí Unlock Unlimited Scans" : loading ? "‚ú¶ Analyzing your meal‚Ä¶" : "‚ú¶ Analyze Meal"}
              </button>

              {error && <div className="error-msg">‚ö†Ô∏è {error}</div>}

              {result && (
                <div className="result-card">
                  <div className="result-hero">
                    <div className="result-name">{result.name}</div>
                    <div className="result-cals-block"><div className="result-cals">{result.calories}</div><div className="result-cals-label">kcal</div></div>
                  </div>
                  <div className="result-macros">
                    {[{l:"Protein",v:result.protein},{l:"Carbs",v:result.carbs},{l:"Fat",v:result.fat}].map(({l,v}) => (
                      <div key={l} className="result-macro"><div className="result-macro-val">{v}<span>g</span></div><div className="result-macro-label">{l}</div></div>
                    ))}
                  </div>
                  {result.notes && <div className="result-notes">üí° {result.notes}</div>}
                  <button className="add-log-btn" onClick={addToLog}>+ Add to Today's Log</button>
                </div>
              )}

              <div className="log-section">
                <div className="section-header">
                  <div className="section-title">Today's Log</div>
                  <div className="section-count">{log.length} items</div>
                </div>
                {log.length === 0 ? (
                  <div className="log-empty">No meals logged yet.<br />Take a photo to get started!</div>
                ) : log.map(item => (
                  <div key={item.id} className="log-item">
                    {item.imageUrl && <img className="log-thumb" src={item.imageUrl} alt={item.name} />}
                    <div className="log-info">
                      <div className="log-name">{item.name}</div>
                      <div className="log-macros"><span className="kcal">{item.calories} kcal</span><span>{item.protein}g P</span><span>{item.carbs}g C</span><span>{item.fat}g F</span></div>
                    </div>
                    <div className="log-meta">
                      <div className="log-time">{item.time}</div>
                      <button className="log-delete" onClick={() => setLog(prev => prev.filter(i => i.id !== item.id))}>√ó</button>
                    </div>
                  </div>
                ))}
              </div>
            </div>

            {showPaywall && (
              <div className="modal-backdrop" onClick={e => e.target === e.currentTarget && setShowPaywall(false)}>
                <div className="modal">
                  <div className="modal-handle" />
                  <div className="modal-header">
                    <div className="modal-badge">‚≠ê ProCals Premium</div>
                    <div className="modal-title">Eat smarter,<br />track everything.</div>
                    <div className="modal-sub">Upgrade for unlimited AI meal scans every day.</div>
                  </div>
                  <div className="modal-features">
                    {[["Unlimited daily meal scans","üì∏"],["Full macro & calorie breakdowns","üìä"],["AI-powered food recognition","ü§ñ"],["Priority analysis speed","‚ö°"]].map(([t,i]) => (
                      <div key={t} className="modal-feature"><div className="feature-check">{i}</div>{t}</div>
                    ))}
                  </div>
                  <div className="modal-price"><div className="price-amount">$12.99</div><div className="price-period">per month ¬∑ cancel anytime</div></div>
                  <button className="modal-cta" onClick={() => { setIsPremium(true); setShowPaywall(false); }}>Start Premium ‚Äî $12.99/mo</button>
                  <button className="modal-dismiss" onClick={() => setShowPaywall(false)}>Maybe later</button>
                </div>
              </div>
            )}
          </div>
        </>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<ProCals />);
  </script>
</body>
</html>
